#Include, MLib\Gdip_All.ahk
#Include, MLib\Gdip_ImageSearch.ahk
#Include, MLib\Bin2Hex.ahk
#Include, MLib\BinRead.ahk
#Include, MLib\Hex2Bin.ahk
#Include, convertImgToPos.ahk
#Include, MLib\SetClipboardData.ahk

#SingleInstance, Force
#NoEnv
CoordMode, Pixel, Screen

F2::
WinGetPos, findSelfX, findSelfY, findSelfWidth, findSelfHeight, SampleWindow
; MsgBox % "found " findSelfX "/" findSelfY "/" findSelfWidth "/" findSelfHeight
Cal_imageSearchTime := A_TickCount
; ImageSearch, OutputVarX, OutputVarY, findSelfX, findSelfY, findSelfX+findSelfWidth, findSelfY+findSelfHeight, sample.bmp
PixelSearch, OutputVarX, OutputVarY, findSelfX, findSelfY, findSelfX+findSelfWidth, findSelfY+findSelfHeight, 0x00FF, ,Fast
if (ErrorLevel = 0) {
  ret := A_TickCount - Cal_imageSearchTime
  MsgBox % "found " OutputVarX "/" OutputVarY "result : " ret "ms"
}
Return

F1::
SetBatchLines, -1
HayStack=SampleWindow
CF_DIB = 8
imageHex =
( Join
2800000014000000110000000100180000000000FC0300000000000000000000
0000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
FFFF0000FF0000FF0000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0000FF0000FF0000
FF0000FF0000FF0000FF0000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0000FF0000FF0000FF0000FF
0000FF0000FF0000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFFFFFFFF0000FF0000FF0000FF0000FF0000FF0000FF00
00FF0000FF0000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
FFFF0000FF0000FFFFFFFFFF0000FF0000FF0000FF0000FF0000FF0000FF0000
FF0000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0000FF0000FF0000
FF0000FFFFFFFFFFFFFFFFFFFFFF0000FF0000FF0000FF0000FF0000FF0000FF
FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0000FF0000FF0000FF0000FF
0000FFFFFFFFFFFFFFFF0000FF0000FF0000FF0000FF0000FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFFFFFFFF0000FF0000FF0000FF0000FF0000FF0000FFFF
FFFFFFFFFFFFFFFFFF0000FF0000FF0000FF0000FFFFFFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFF0000FF0000FF0000FF0000FF0000FF0000FF0000FF0000
FFFFFFFFFF0000FF0000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
FFFFFFFFFF0000FF0000FF0000FF0000FF0000FF0000FF0000FF0000FF0000FF
FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
FFFFFFFF0000FF0000FF0000FF0000FF0000FF0000FF0000FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
0000FF0000FF0000FF0000FF0000FF0000FF0000FFFFFFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
FFFF0000FF0000FF0000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
FFFFFFFF00000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000008000000FFFFFFFF004E000001000000
0000000000000000000000000000000080000000E0000000558C46BA5699B14F
A59D52A7DD7CC6AA0E0000000200000005400080600700004807000000000000
28EF1D0100000000000000004800000058000000600000000800000001000400
0800000000000000200000000100020001000000030000000500000006000000
07000000080000000400000002000000A8000000FFFFFFFF604D00000F000000
0A00000000000000010020004000000000000000000000002000000000000000
0000000010000000100000000200000001000100020000000000000000000000
0000000000000000000000000000000088120000FFFFFFFF004D000001000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000088120000FFFFFFFFA04C000001000000
0000000000000000000000000000000000000000000000000000000080000000
8000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000080000000
80000000000000000000000000000000E8010000FFFFFFFF204C000001000000
0000000000000000000000000000000000000000000000008000000080000000
8000000080000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000008000000000000000
0000000080000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000800000008000000000000000
0000000080000000800000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000800000000000000000000000
0000000000000000800000000000000000000000000000000000000000000000
0000000000000000000000000000000080000000800000000000000000000000
0000000000000000800000008000000000000000000000000000000000000000
0000000000000000000000000000000080000000800000000000000000000000
0000000000000000800000008000000000000000000000000000000000000000
0000000000000000000000008000000080000000000000000000000000000000
0000000000000000000000008000000080000000000000000000000000000000
0000000000000000000000008000000000000000000000000000000000000000
0000000000000000000000000000000080000000000000000000000000000000
0000000000000000800000000000000000000000000000000000000000000000
0000000000000000000000000000000080000000800000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
FFFFFFFFFE7FFE7FFC3FFC3FF99FF99FF3CFF3CFE007E7E7CFF387E1FFFFFFFF
8001C003E007FFCF000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
)
Cal_imageSearchTime := A_TickCount
imageLen := Hex2Bin(image, imageHex)
SetClipboardData(CF_DIB, image, imageLen)
If !pToken := Gdip_Startup()
{
   MsgBox, 48, gdiplus error!, Gdiplus failed to start. Please ensure you have gdiplus on your system
   ExitApp
}
OnExit, Exit
WinGet, hwndHay, ID, %HayStack%
; pBitmapHayStack := Gdip_BitmapFromHWND(hwndHay)
WinGetPos, findSelfX, findSelfY, findSelfWidth, findSelfHeight, SampleWindow
raster:=0x40000000 + 0x00CC0020
pBitMapTemp := Gdip_BitmapFromScreen(0,raster)

pBitmapHayStack := Gdip_CloneBitmapArea(pBitMapTemp, findSelfX, findSelfY, findSelfX+findSelfWidth, findSelfY+findSelfHeight)

pBitmapNeedle := Gdip_CreateBitmapFromClipboard()
ret := Gdip_SaveBitmapToFile(pBitmapNeedle, "sample.bmp")
Width1 := Gdip_GetImageWidth(pBitmapHayStack), Height1 := Gdip_GetImageHeight(pBitmapHayStack)
Width2 := Gdip_GetImageWidth(pBitmapNeedle), Height2 := Gdip_GetImageHeight(pBitmapNeedle)
E1 := Gdip_LockBits(pBitmapHayStack, 0, 0, Width1, Height1, Stride1, Scan01, BitmapData1)
E2 := Gdip_LockBits(pBitmapNeedle, 0, 0, Width2, Height2, Stride2, Scan02, BitmapData2)
MCode(Gdip_ImageSearch, "83EC148B4424309983E20303C28BC88B442434995383E2035503C2C1F80256C1F902837C24"
. "30005789442420C7442410000000000F8EBE0000008B5C24288B7C24388D048D00000000894424188B442430895C241CE"
. "B098DA424000000008BFFC74424440000000085C07E6D895C24148B6C242CC7442440000000008D6424008B4C24403B4C"
. "243C0F8D8600000033C985FF7E158BD58BF38B063B02751F4183C20483C6043BCF7CEF8B442420035C2418FF44244003C"
. "003C003E8EBC38B4C24448B5C24148B4424304183C3043BC8894C2444895C24147C978B4C24108B5C241C035C2418413B"
. "4C2434894C2410895C241C0F8C68FFFFFF8B5424488B44244C5F5E5DC702FFFFFFFFC700FFFFFFFF5B83C414C38B4C244"
. "48B5424488B44244C5F495E890A8B4C24085D89085B83C414C3")
VarSetCapacity(x, 8, 0), VarSetCapacity(y, 8, 0)
Loop, 5
   DllCall(&Gdip_ImageSearch, "uint", Scan01, "uint", Scan02, "int", Width1, "int", Height1, "int", Width2, "int", Height2, "int", Stride1, "int", Stride2, "int*", x, "int*", y)
ret := A_TickCount - Cal_imageSearchTime
MsgBox, %x% / %y% %ret% ms

Gdip_UnlockBits(pBitmapHayStack, BitmapData1), Gdip_UnlockBits(pBitmapNeedle, BitmapData2)
Gdip_DisposeImage(pBitmapHayStack), Gdip_DisposeImage(pBitmapNeedle)
return

MCode(ByRef code, hex)
{
   VarSetCapacity(code, StrLen(hex)//2)
   Loop % StrLen(hex)//2      ;%
      NumPut("0x" SubStr(hex, 2*A_Index-1, 2), code, A_Index-1, "char")
}
Exit:
Gdip_Shutdown(pToken)
ExitApp
return
